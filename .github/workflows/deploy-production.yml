name: ðŸš€ Deploy Turnstile Admin (Production)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.PROD_TURNSTILE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p 22 ${{ secrets.PROD_TURNSTILE_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to Production Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROD_TURNSTILE_HOST }}
          username: ${{ secrets.PROD_TURNSTILE_USER }}
          key: ${{ secrets.PROD_TURNSTILE_KEY }}
          port: 22
          script: |
            cd /var/www/turnstile-admin

            echo "ðŸ”¹ ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÐºÐ¾Ð´..."
            git reset --hard
            git fetch --all
            git checkout main
            git pull origin main

            echo "ðŸ”¹ ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹..."
            docker compose -f docker-compose.prod.yml -p turnstile-prod pull
            docker compose -f docker-compose.prod.yml -p turnstile-prod up -d --build

            echo "ðŸ§¹ Ð§Ð¸ÑÑ‚Ð¸Ð¼ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°..."
            docker container prune -f --filter "label=com.docker.compose.project=turnstile-prod"

            echo "ðŸ§¹ Ð§Ð¸ÑÑ‚Ð¸Ð¼ Ð¾Ð±Ñ€Ð°Ð·Ñ‹..."
            docker image prune -f

            echo "ðŸ”¹ ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ composer..."
            if git diff --name-only HEAD~1 | grep -E "composer(\.lock)?\.json" > /dev/null; then
              docker compose -f docker-compose.prod.yml -p turnstile-prod exec -T app composer install --no-interaction --optimize-autoloader
            fi

            echo "ðŸ”¹ ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ npm..."
            if git diff --name-only HEAD~1 | grep -E "package(-lock)?\.json" > /dev/null; then
              docker compose -f docker-compose.prod.yml -p turnstile-prod exec -T app rm -rf node_modules package-lock.json
              docker compose -f docker-compose.prod.yml -p turnstile-prod exec -T app npm install
            fi

            echo "ðŸ”¹ Ð¡Ð±Ð¾Ñ€ÐºÐ° Ñ„Ñ€Ð¾Ð½Ñ‚Ð° (Filament / Vite)..."
            docker compose -f docker-compose.prod.yml -p turnstile-prod exec -T app npm run build

            echo "ðŸ”¹ ÐœÐ¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸..."
            docker compose -f docker-compose.prod.yml -p turnstile-prod exec -T app php artisan migrate --force

            echo "ðŸ”¹ ÐšÐµÑˆÐ¸ Laravel..."
            docker compose -f docker-compose.prod.yml -p turnstile-prod exec -T app php artisan optimize:clear

            echo "âœ… Deploy turnstile-admin completed!"
